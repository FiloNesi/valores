<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Autoestima y valor propio — Cuento y actividad</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- TailwindCSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --green:#10b981; /* emerald-500 */
      --amber:#f59e0b; /* amber-500  */
      --red:#ef4444;   /* red-500    */
    }
    html,body{height:100%}
    body{font-family:'Inter',system-ui,Segoe UI,Roboto,Arial,sans-serif;background:#fafafa}
    @media print{
      #toolbar, #legend, #toast { display:none !important; }
      .no-print{ display:none !important; }
      .print-show{ display:block !important; }
      textarea, input[type="text"]{ border:1px solid #ddd !important; }
    }
    #toast{position:fixed;inset:auto 1rem 1rem auto;background:#111;color:#fff;padding:.6rem .8rem;border-radius:.5rem;opacity:0;transform:translateY(12px);transition:.2s}
    #toast.show{opacity:1;transform:translateY(0)}
  </style>
</head>
<body>
  <header class="bg-white shadow-sm sticky top-0 z-30">
    <div class="max-w-6xl mx-auto px-4 py-4 flex flex-col sm:flex-row gap-3 sm:items-center sm:justify-between">
      <div class="flex items-center gap-3">
        <div class="h-10 w-10 rounded-2xl bg-gradient-to-br from-emerald-400 via-amber-400 to-red-400"></div>
        <div>
          <h1 class="text-xl font-[700] leading-tight">Autoestima y valor propio</h1>
          <p class="text-sm text-gray-600">Cuento “El verdadero valor del anillo” + actividad: <span class="font-medium">Nos entrenamos en... autoestima</span>.</p>
        </div>
      </div>

      <div id="toolbar" class="flex flex-wrap items-center gap-2">
        <input id="studentName" class="px-3 py-2 border rounded-lg text-sm" placeholder="Nombre (opcional)" />
        <button id="btnLegend" class="px-3 py-2 rounded-lg bg-amber-50 hover:bg-amber-100 text-amber-800 text-sm">Guía rápida</button>
        <button id="btnExport" class="px-3 py-2 rounded-lg bg-gray-100 hover:bg-gray-200 text-sm">Exportar CSV</button>
        <button id="btnPrint" class="px-3 py-2 rounded-lg bg-gray-900 hover:bg-black text-white text-sm">Imprimir</button>
        <button id="btnReset" class="px-3 py-2 rounded-lg bg-red-50 hover:bg-red-100 text-red-700 text-sm">Reiniciar</button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6 space-y-6">
    <!-- Guía / Leyenda -->
    <section id="legend" class="hidden rounded-xl border bg-white p-4 text-sm">
      <div class="grid sm:grid-cols-2 gap-4">
        <div class="rounded-lg border-l-4" style="border-left-color:var(--green)">
          <div class="px-3 py-2">
            <h3 class="font-semibold text-emerald-700">Cómo usar esta página</h3>
            <ul class="list-disc list-inside text-gray-700 space-y-1">
              <li>Lee el cuento y marca <em>“Leído”</em>. Puedes usar el temporizador.</li>
              <li>Anota 3 ideas clave, una conexión con la autoestima y tu cita favorita.</li>
              <li>Responde la actividad (Sí / A veces / No). Se calcula tu perfil automáticamente.</li>
              <li>Elige una meta y reescribe en positivo una idea a mejorar.</li>
              <li>Exporta a CSV o imprime para entregar.</li>
            </ul>
          </div>
        </div>
        <div class="rounded-lg border-l-4" style="border-left-color:var(--amber)">
          <div class="px-3 py-2">
            <h3 class="font-semibold text-amber-700">Privacidad y progreso</h3>
            <p class="text-gray-700">Todo se guarda en tu navegador (<strong>localStorage</strong>). Puedes reiniciar en cualquier momento.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Progreso general -->
    <section class="rounded-xl border bg-white p-4">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
        <div class="text-sm text-gray-700">
          Completado: <span id="progressPct" class="font-semibold">0%</span>
        </div>
        <div class="w-full sm:w-2/3 bg-gray-100 rounded-full h-2 overflow-hidden">
          <div id="progressBar" class="h-full bg-gradient-to-r from-emerald-400 via-amber-400 to-red-400" style="width:0%"></div>
        </div>
      </div>
    </section>

    <!-- 1) Cuento -->
    <section class="rounded-xl border bg-white">
      <div class="p-4 border-b flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
        <div>
          <h2 class="font-semibold text-lg">Cuento: <span class="text-gray-800">EL VERDADERO VALOR DEL ANILLO</span></h2>
          <p class="text-sm text-gray-600">Autor: Jorge Bucay</p>
        </div>
        <div class="flex items-center gap-2">
          <button id="btnStartTimer" class="px-3 py-2 rounded-lg bg-gray-100 hover:bg-gray-200 text-sm">Iniciar temporizador</button>
          <button id="btnStopTimer" class="px-3 py-2 rounded-lg bg-gray-100 hover:bg-gray-200 text-sm">Detener</button>
          <span class="text-sm text-gray-600">Tiempo: <span id="readTime">0:00</span></span>
          <label class="inline-flex items-center gap-2 text-sm">
            <input id="readDone" type="checkbox" class="h-4 w-4">
            <span>Leído</span>
          </label>
        </div>
      </div>

      <div class="p-4 space-y-3 leading-relaxed text-[15px]">
        <p><strong>EL VERDADERO VALOR DEL ANILLO</strong></p>
        <p>Un joven concurrió a un sabio en busca de ayuda. </p>
        <p>- Vengo, maestro, porque me siento tan poca cosa que no tengo fuerzas para hacer nada. Me dicen que no sirvo, que no hago nada bien, que soy torpe y bastante tonto. ¿Cómo puedo mejorar maestro?. ¿Qué puedo hacer para que me valoren más? </p>
        <p>El maestro, sin mirarlo, le dijo: </p>
        <p>- ¡Cuánto lo siento muchacho, no puedo ayudarte, debo resolver primero mis propios problemas. Quizás después... Si quisieras ayudarme tú a mí, yo podría resolver este tema con más rapidez y después tal vez te pueda ayudar. </p>
        <p>- E... encantado, maestro -titubeó el joven pero sintió que otra vez era desvalorizado y sus necesidades postergadas-. </p>
        <p>- Bien -asintió el maestro-. Se quitó un anillo que llevaba en el dedo pequeño de la mano izquierda y dándoselo al muchacho agregó: Toma el caballo que está allí afuera y cabalga hasta el mercado. Debo vender este anillo para pagar una deuda. Es necesario que obtengas por él la mayor suma posible, pero no aceptes menos de una moneda de oro. Vete y regresa con esa moneda lo más rápido que puedas. </p>
        <p>El joven tomó el anillo y partió. Apenas llegó, empezó a ofrecer el anillo a los mercaderes. Estos lo miraban con algún interés hasta que el joven decía lo que pretendía por el anillo. Cuando el joven mencionaba la moneda de oro, algunos reían, otros le daban vuelta la cara y sólo un viejito fue tan amable como para tomarse la molestia de explicarle que una moneda de oro era muy valiosa para entregarla a cambio de un anillo. </p>
        <p>En afán de ayudar, alguien le ofreció una moneda de plata y un cacharro de cobre, pero el joven tenía instrucciones de no aceptar menos de una moneda de oro, así que rechazó la oferta.</p>
        <p>Después de ofrecer su joya a toda persona que se cruzaba en el mercado - más de cien personas- y abatido por su fracaso, montó su caballo y regresó. </p>
        <p>¡Cuánto hubiese deseado el joven tener él mismo esa moneda de oro! Podría habérsela entregado al maestro para liberarlo de su preocupación y recibir entonces su consejo y su ayuda. </p>
        <p>- Maestro -dijo- lo siento, no es posible conseguir lo que me pediste. Quizás pudiera conseguir 2 ó 3 monedas de plata, pero no creo que yo pueda engañar a nadie respecto del verdadero valor del anillo. </p>
        <p>- ¡Qué importante lo que dijiste, joven amigo! -contestó sonriente el maestro- . Debemos saber primero el verdadero valor del anillo. Vuelve a montar y vete al joyero. ¿Quién mejor que él para saberlo?. Dile que quisieras vender el anillo y pregúntale cuánto da por él. Pero no importa lo que ofrezca, no se lo vendas. Vuelve aquí con mi anillo. </p>
        <p>El joven volvió a cabalgar. El joyero examinó el anillo a la luz del candil, lo miró con su lupa, lo pesó y luego le dijo: </p>
        <p>- Dile al maestro, muchacho, que si lo quiere vender ya, no puedo darle más que 58 monedas de oro por su anillo. </p>
        <p>- ¿¿¿¿58 monedas???? -exclamó el joven-. </p>
        <p>- Sí, -replicó el joyero-. Yo sé que con tiempo podríamos obtener por él cerca de 70 monedas, pero no sé... Si la venta es urgente... </p>
        <p>El joven corrió emocionado a casa del maestro a contarle lo sucedido.</p>
        <p>- Siéntate -dijo el maestro después de escucharlo-. Tú eres como este anillo: una joya única y valiosa. Y como tal, sólo puede evaluarte verdaderamente un experto. ¿Qué haces por la vida pretendiendo que cualquiera descubra tu verdadero valor? </p>
        <p>Y diciendo esto, volvió a ponerse el anillo en el dedo pequeño de su mano izquierda. </p>
      </div>

      <!-- Reflexión sobre el cuento -->
      <div class="p-4 border-t grid md:grid-cols-2 gap-4">
        <div class="rounded-xl border bg-white p-4">
          <h3 class="font-semibold mb-2">Tus 3 ideas clave</h3>
          <div class="space-y-2">
            <textarea data-idea="0" class="w-full px-3 py-2 border rounded-lg text-sm" placeholder="Idea clave #1"></textarea>
            <textarea data-idea="1" class="w-full px-3 py-2 border rounded-lg text-sm" placeholder="Idea clave #2"></textarea>
            <textarea data-idea="2" class="w-full px-3 py-2 border rounded-lg text-sm" placeholder="Idea clave #3"></textarea>
          </div>
        </div>
        <div class="rounded-xl border bg-white p-4 space-y-3">
          <div>
            <h3 class="font-semibold mb-2">Conexión con la autoestima</h3>
            <textarea id="linkSelf" class="w-full px-3 py-2 border rounded-lg text-sm" placeholder="¿Qué enseña este cuento sobre valorarse a uno mismo?"></textarea>
          </div>
          <div>
            <h3 class="font-semibold mb-2">Cita favorita</h3>
            <input id="favQuote" type="text" class="w-full px-3 py-2 border rounded-lg text-sm" placeholder="Escribe aquí la frase que más te ha impactado" />
          </div>
        </div>
      </div>
    </section>

    <!-- 2) Teoría Autoestima -->
 <section class="rounded-xl border bg-white">
      <div class="p-4 border-b">
        <img src="https://filonesi.github.io/valores/iconos/exclamation.png" alt="icono_exclamacion" width="50" height="50">

        <h2 class="font-semibold text-lg">Actividad: <span class="text-gray-800">¿Qué es la autoestima?</span></h2>
      </div>
    </div>
       <div class="p-4 space-y-3 leading-relaxed text-[15px]">
        <p>Una persona tiene autoestima cuando es capaz de evaluarse de manera positiva y de confiar en sus capacidades, pero también de reconocer sus límites con serenidad. Si te aceptas y te quieres podrás relacionarte mucho mejor con los demás. </p>
        <p>- La <b>autoestima</b> es el aprecio y la consideración que una persona tiene de sí misma.</p>
         <p>La autoestima es el sentimientoque nos hace valorar nuestra personalidad y querernos.</p>
         <p>La valoración positiva y el amor propioson muy importantes.</p>
         <p>Cuando nos queremos y valoramos, sabemos que merecemos relaciones que nos hacen sentir bien y nos hacen felices.</p>
         <p>Con una buena autoestima, es más fácil <b>decir no</b> a las relaciones con malos rollos.</p>
         <p>Es importante recordar que <b>el amor propio es lo más importante.</b></p>
        
      </div>
 </section>   


     <!-- 2) Actividad Autoestima -->
    <section class="rounded-xl border bg-white">
      <div class="p-4 border-b">
        <h2 class="font-semibold text-lg">Actividad: <span class="text-gray-800">Nos entrenamos en... autoestima</span></h2>
                <p class="text-sm text-gray-600">Indica qué afirmaciones reconoces en ti (Sí / A veces / No). Se calcula tu perfil automáticamente.</p>

     
    </section>

      <div class="p-4 space-y-4">
        <div class="rounded-xl border bg-white">
          <div class="grid grid-cols-[1fr_auto_auto_auto] gap-3 px-3 py-2 border-b text-sm font-semibold text-gray-700">
            <div>Afirmación</div>
            <div class="text-center">Sí</div>
            <div class="text-center">A veces</div>
            <div class="text-center">No</div>
          </div>
          <div id="itemsContainer" class="divide-y"></div>
        </div>

        <div class="grid md:grid-cols-2 gap-4">
          <div class="rounded-xl border bg-white p-4 space-y-2">
            <h3 class="font-semibold">Resultados</h3>
            <p class="text-sm text-gray-700">Puntuación: <span id="scoreVal" class="font-semibold">0</span>/20</p>
            <div class="w-full bg-gray-100 rounded-full h-2 overflow-hidden">
              <div id="scoreBar" class="h-full bg-gradient-to-r from-red-400 via-amber-400 to-emerald-400" style="width:0%"></div>
            </div>
            <p class="text-sm text-gray-700">Perfil: <span id="scoreLabel" class="font-semibold">—</span></p>
            <p class="text-xs text-gray-500">Interpretación orientativa: 0–7 <em>por trabajar</em>, 8–14 <em>en desarrollo</em>, 15–20 <em>robusta</em>.</p>
          </div>

          <div class="rounded-xl border bg-white p-4 space-y-3">
            <h3 class="font-semibold">Tu meta y reescritura positiva</h3>
            <label class="text-sm text-gray-700 block">Elige una afirmación para mejorar (de tus “alertas”):</label>
            <select id="goalSelect" class="w-full px-3 py-2 border rounded-lg text-sm"></select>
            <label class="text-sm text-gray-700 block mt-2">Reescribe en positivo (formato “yo…” realista y concreto):</label>
            <textarea id="rewrite" class="w-full px-3 py-2 border rounded-lg text-sm" placeholder="Ej.: Yo puedo decir no con respeto cuando algo no me hace bien."></textarea>
          </div>
        </div>
      </div>
    </section>

    <p class="text-xs text-gray-500 text-center">Los datos se guardan solo en tu navegador (localStorage). No se envían a ningún servidor.</p>
  </main>

  <!-- Toast -->
  <div id="toast" role="status" aria-live="polite"></div>

  <script>
    /******************** Estado ********************/
    const STORAGE_KEY = 'anillo_autoestima_v1';

    const POS = 'pos', NEG = 'neg';
    const itemsData = [
      { id:'s1',  text:'Reconozco mis cualidades y éxitos.', type: POS },
      { id:'s2',  text:'Me perdono cuando me equivoco.', type: POS },
      { id:'s3',  text:'Pienso que los demás son mejores que yo.', type: NEG },
      { id:'s4',  text:'Me cuido y me doy cuenta de mis necesidades.', type: POS },
      { id:'s5',  text:'Me infravaloro y pienso que no soy capaz.', type: NEG },
      { id:'s6',  text:'Me cuesta decir "no" por miedo a desagradar a los demás.', type: NEG },
      { id:'s7',  text:'Prefiero no tomar decisiones para no equivocarme.', type: NEG },
      { id:'s8',  text:'Aunque no me salga algo, lo vuelvo a intentar.', type: POS },
      { id:'s9',  text:'Para gustar a los demás, hay que hacer lo que quiera la mayoría.', type: NEG },
      { id:'s10', text:'Pienso que los demás consideran que no soy capaz.', type: NEG },
    ];

    let state = loadState();

    function defaultState(){
      return {
        studentName: '',
        progress: 0,
        story: {
          read: false,
          timeSec: 0,
          ideas: ['', '', ''],
          link: '',
          quote: ''
        },
        activity: {
          answers: Object.fromEntries(itemsData.map(it => [it.id, ''])), // 'si'|'aveces'|'no'|''
          score: 0,
          label: '',
          goalId: '',
          rewrite: ''
        },
        timerRunning: false,
        timerStart: null
      };
    }

    function loadState(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(raw) {
          const parsed = JSON.parse(raw);
          // saneo mínimo
          if(parsed && parsed.activity && parsed.story) return parsed;
        }
      }catch(e){}
      return defaultState();
    }

    function saveState(){
      try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }catch(e){}
    }

    /******************** Utilidades ********************/
    const qs = s => document.querySelector(s);
    const qsa = s => Array.from(document.querySelectorAll(s));

    function showToast(msg){
      const t = qs('#toast');
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(()=>t.classList.remove('show'), 1600);
    }

    function fmtTime(sec){
      sec = Math.max(0, Math.floor(sec));
      const m = Math.floor(sec/60);
      const s = sec%60;
      return m + ':' + String(s).padStart(2,'0');
    }

    /******************** Render ********************/
    function renderProgress(){
      // Puntos de progreso:
      // Cuento: leído (1), 3 ideas (3), link (1), cita (1) = 6
      // Actividad: 10 respuestas = 10, meta elegida (1), reescritura (1) = 12
      // Total 18 → porcentaje
      let pts = 0;
      const S = state;
      if(S.story.read) pts += 1;
      pts += S.story.ideas.filter(x=>x.trim().length>0).length; // 0..3
      if(S.story.link.trim().length>0) pts += 1;
      if(S.story.quote.trim().length>0) pts += 1;

      const answered = Object.values(S.activity.answers).filter(v=>v).length; // 0..10
      pts += answered;
      if(S.activity.goalId) pts += 1;
      if(S.activity.rewrite.trim().length>0) pts += 1;

      const total = 18;
      const pct = Math.round( (pts/total)*100 );
      state.progress = pct;
      qs('#progressPct').textContent = pct + '%';
      qs('#progressBar').style.width = pct + '%';
    }

    function renderStory(){
      // Inputs
      qs('#studentName').value = state.studentName || '';
      qs('#readDone').checked = !!state.story.read;
      qs('#readTime').textContent = fmtTime(state.story.timeSec);
      qsa('textarea[data-idea]').forEach(ta=>{
        const i = +ta.dataset.idea;
        ta.value = state.story.ideas[i] || '';
      });
      qs('#linkSelf').value = state.story.link || '';
      qs('#favQuote').value = state.story.quote || '';
    }

    function renderItems(){
      const container = qs('#itemsContainer');
      container.innerHTML = '';
      itemsData.forEach((it, idx)=>{
        const row = document.createElement('div');
        row.className = "grid grid-cols-[1fr_auto_auto_auto] gap-3 px-3 py-3 items-center";
        const lab = document.createElement('div');
        lab.className = "text-sm text-gray-800";
        lab.textContent = it.text;

        const mkRadio = (val,label) => {
          const wrap = document.createElement('label');
          wrap.className = "flex items-center justify-center";
          wrap.innerHTML = `
            <input type="radio" name="${it.id}" value="${val}" class="h-4 w-4" ${state.activity.answers[it.id]===val?'checked':''}>
          `;
          return wrap;
        };

        row.appendChild(lab);
        row.appendChild(mkRadio('si','Sí'));
        row.appendChild(mkRadio('aveces','A veces'));
        row.appendChild(mkRadio('no','No'));

        container.appendChild(row);
      });

      // Goal select
      fillGoalOptions();
      // Score
      updateScore();
    }

    function fillGoalOptions(){
      const sel = qs('#goalSelect');
      const alerts = getAlerts(); // ids con respuesta “riesgo”
      const cur = state.activity.goalId || '';
      sel.innerHTML = '';
      const opt0 = document.createElement('option');
      opt0.value = '';
      opt0.textContent = alerts.length ? '— Elige una afirmación para mejorar —' : 'Sin alertas por ahora';
      sel.appendChild(opt0);
      alerts.forEach(id=>{
        const it = itemsData.find(x=>x.id===id);
        const o = document.createElement('option');
        o.value = id;
        o.textContent = it ? it.text : id;
        sel.appendChild(o);
      });
      if(cur) sel.value = cur;
    }

    function getAlerts(){
      // Alerta = en POS: respuesta "no" o "aveces"; en NEG: respuesta "si" o "aveces"
      const A = state.activity.answers;
      return itemsData.filter(it=>{
        const v = A[it.id];
        if(!v) return false;
        if(it.type===POS) return (v==='no' || v==='aveces');
        if(it.type===NEG) return (v==='si' || v==='aveces');
        return false;
      }).map(it=>it.id);
    }

    function updateScore(){
      // Puntos por ítem: POS: si=2, aveces=1, no=0; NEG invertido: si=0, aveces=1, no=2
      let score = 0;
      itemsData.forEach(it=>{
        const v = state.activity.answers[it.id];
        if(!v) return;
        if(it.type===POS){
          if(v==='si') score+=2; else if(v==='aveces') score+=1;
        }else{
          if(v==='no') score+=2; else if(v==='aveces') score+=1;
        }
      });
      state.activity.score = score;
      const pct = Math.round((score/20)*100);
      qs('#scoreVal').textContent = score;
      qs('#scoreBar').style.width = pct + '%';
      let label = '—';
      if(score<=7) label='Por trabajar';
      else if(score<=14) label='En desarrollo';
      else label='Robusta';
      state.activity.label = label;
      qs('#scoreLabel').textContent = label;
    }

    function renderAll(){
      renderStory();
      renderItems();
      renderProgress();
    }

    /******************** Eventos ********************/
    // Barra superior
    qs('#studentName').addEventListener('input', e=>{
      state.studentName = e.target.value;
      saveState(); renderProgress();
    });

    qs('#btnLegend').addEventListener('click', ()=>{
      qs('#legend').classList.toggle('hidden');
    });

    qs('#btnExport').addEventListener('click', ()=>{
      const rows = [];
      rows.push(['Nombre', state.studentName || '']);
      rows.push(['Tiempo lectura (s)', state.story.timeSec]);
      rows.push(['Leído', state.story.read ? 'sí':'no']);
      rows.push(['Idea 1', state.story.ideas[0]||'']);
      rows.push(['Idea 2', state.story.ideas[1]||'']);
      rows.push(['Idea 3', state.story.ideas[2]||'']);
      rows.push(['Conexión', state.story.link||'']);
      rows.push(['Cita favorita', state.story.quote||'']);
      rows.push([]);
      rows.push(['ID','Afirmación','Tipo','Respuesta']);
      itemsData.forEach(it=>{
        rows.push([it.id, it.text, it.type, state.activity.answers[it.id]||'']);
      });
      rows.push([]);
      rows.push(['Puntuación', state.activity.score]);
      rows.push(['Perfil', state.activity.label]);
      rows.push(['Meta (ID)', state.activity.goalId||'']);
      const goalText = itemsData.find(x=>x.id===state.activity.goalId)?.text || '';
      rows.push(['Meta (texto)', goalText]);
      rows.push(['Reescritura', state.activity.rewrite||'']);

      const csv = rows.map(r=>r.map(cell=>{
        const s = String(cell??'');
        return /[",;\n]/.test(s) ? '"'+s.replace(/"/g,'""')+'"' : s;
      }).join(';')).join('\n');

      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'autoestima_anillo.csv';
      document.body.appendChild(a); a.click();
      setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
    });

    qs('#btnPrint').addEventListener('click', ()=> window.print());

    qs('#btnReset').addEventListener('click', ()=>{
      if(!confirm('¿Seguro que quieres reiniciar? Se borrarán todas las respuestas.')) return;
      localStorage.removeItem(STORAGE_KEY);
      state = defaultState();
      renderAll();
      showToast('Reiniciado');
    });

    // Cuento
    // Timer
    let tickHandle = null;
    function startTimer(){
      if(state.timerRunning) return;
      state.timerRunning = true;
      state.timerStart = Date.now();
      tickHandle = setInterval(()=>{
        const now = Date.now();
        const delta = Math.floor((now - state.timerStart)/1000);
        qs('#readTime').textContent = fmtTime(state.story.timeSec + delta);
      }, 250);
      showToast('Temporizador iniciado');
    }
    function stopTimer(){
      if(!state.timerRunning) return;
      clearInterval(tickHandle);
      const delta = Math.floor((Date.now() - state.timerStart)/1000);
      state.story.timeSec += delta;
      state.timerRunning = false;
      state.timerStart = null;
      qs('#readTime').textContent = fmtTime(state.story.timeSec);
      saveState();
      showToast('Temporizador detenido');
    }
    qs('#btnStartTimer').addEventListener('click', startTimer);
    qs('#btnStopTimer').addEventListener('click', stopTimer);

    qs('#readDone').addEventListener('change', e=>{
      state.story.read = e.target.checked;
      saveState(); renderProgress();
    });

    qsa('textarea[data-idea]').forEach(ta=>{
      ta.addEventListener('input', e=>{
        const i = +e.target.dataset.idea;
        state.story.ideas[i] = e.target.value;
        saveState(); renderProgress();
      });
    });

    qs('#linkSelf').addEventListener('input', e=>{
      state.story.link = e.target.value;
      saveState(); renderProgress();
    });
    qs('#favQuote').addEventListener('input', e=>{
      state.story.quote = e.target.value;
      saveState(); renderProgress();
    });

    // Actividad: radios
    document.addEventListener('change', e=>{
      const r = e.target;
      if(r && r.type==='radio' && r.name && r.value && state.activity.answers.hasOwnProperty(r.name)){
        state.activity.answers[r.name] = r.value; // 'si'|'aveces'|'no'
        saveState();
        updateScore();
        fillGoalOptions();
        renderProgress();
      }
    });

    // Meta y reescritura
    qs('#goalSelect').addEventListener('change', e=>{
      state.activity.goalId = e.target.value || '';
      saveState(); renderProgress();
    });
    qs('#rewrite').addEventListener('input', e=>{
      state.activity.rewrite = e.target.value;
      saveState(); renderProgress();
    });

    /******************** Inicio ********************/
    function init(){
      renderAll();
    }
    init();
  </script>
</body>
</html>
